---
title: "compicc Explained"
author: "Riley Mulshine, Alan Huebner"
date: "02/21/2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{compicc Explained}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# 1. Summary

The compicc package is intended for practicioners in a wide range of fields, most notably psychology, medicine, and sports science. It allows users to compare the reliability of two measurement systems or one system at two different time points. For example, one could compare the reliability of two different medical practicioners' measurements on patients' shoulder mobility in degrees of rotation. Similarly, a coach could study the reliability of a force plate measuring athletes' physical performances at two time points a year apart to determine if the system's reliability has drifted.

The two functions in compicc calculate the confidence interval with a user-defined confidence level of the difference of one dataframe's intraclass correlation coefficient (ICC) versus another dataframe's ICC. These two functions are **dep_ci()** and **indep_ci()**, whose uses will be explained in Section 2.

In addition, the package contains two sets of two dataframes (four total dataframes) to be used as demonstrations of the functions' capabilities. These dataframes are titled **dep_ex_df1** and **dep_ex_df2**, as well as **indep_ex_df1** and **indep_ex_df2**. In Section 3, this document will call the package's functions with these sets of dataframes and interpret the results for instructional purposes.

To start, the package is loaded with the code:

``` {r}
library(compicc)
```

# 2. Included Elements

The compicc package includes two different functions: **dep_ci()** and **indep_ci()**. Determining which function to use depends on whether the same set of subjects or a different set of subjects were tested in each dataset being compared.

## 2.1. Confidence Interval for Dependent Data: dep_ci()

Dependent data refers to the scenario in which the same set of subjects were tested in each dataset. For example, observations in row 1 of the first dataset are taken from the same subject as observations in row 1 of the second dataset. This holds true for every row of data, so the observations between datasets are "matched."

The **dep_ci()** function is called with three inputs: data1, data2 and conf_level. The input data1 refers to the first dataset being compared, and data2 refers to the second dataset being compared. The input conf_level refers to the confidence level of the confidence interval. This value defaults to 0.95 when not defined by the user, representing a 95% confidence interval.

The function will return 3 values:

* data1ICC: intraclass correlation coefficient of data1
* data2ICC: intraclass correlation coefficient of data2
* confidenceIntervalDifference: 1x2 dataframe with the lower bound and upper bound of the confidence interval for the difference of the ICC of data1 and data2
    * confidenceIntervalDifference$lowerBound: lower bound of confidence interval
    * confidenceIntervalDifference$upperBound: upper bound of confidence interval

The confidence interval will represent the value *ICC(data1) - ICC(data2)*.

## 2.2. Confidence Interval for Inependent Data: indep_ci()

Independent data refers to the scenario in which an entirely different set of subjects were tested from one dataset to the next. This means there are no subjects who were tested in both the first dataframe and the second dataframe.

The **indep_ci()** function is called with three inputs: data1, data2 and conf_level. The input data1 refers to the first dataset being compared, and data2 refers to the second dataset being compared. The input conf_level refers to the confidence level of the confidence interval. This value defaults to 0.95 when not defined by the user, representing a 95% confidence interval.

The function will return 3 values:

* data1ICC: intraclass correlation coefficient of data1
* data2ICC: intraclass correlation coefficient of data2
* confidenceIntervalDifference: 1x2 dataframe with the lower bound and upper bound of the confidence interval for the difference between the ICC of data1 and data2
    * confidenceIntervalDifference$lowerBound: lower bound of confidence interval
    * confidenceIntervalDifference$upperBound: upper bound of confidence interval

The confidence interval will represent the value *ICC(data1) - ICC(data2)*.

## 2.3. Included Data

The compicc package contains four internal datasets that come installed with the package. These dataframes are provided so that the user may see and work through an example of the functions within the package. The four dataframes shall be grouped into two sets: one set consisting of two dependent dataframes, and the other set consisting of two independent dataframes.

Initially, consider the two dependent dataframes, **dep_ex_df1** and **dep_ex_df2**. Both consist of simulated data of 4 trials of measurements for 100 subjects. The data represents a hypothetical score assigned to the subjects, where the overall mean score is zero. Each dataframe contains the same 100 subjects (paired observations), meaning the dataframes are dependent. The dataframes are in wide format, meaning each row represents the measurements of one subject across four trials split column-wise. This format is required for all functions in the compicc package to run.

In this example, **dep_ex_df1** contains the measurements of the 100 subjects by a sensor at an initial time. Then, **dep_ex_df2** contains the measurements of the same 100 subjects by the same sensor at a final time. In such an instance, the user would be looking to quantify how the sensor's reliability has changed over time.


Meanwhile, **indep_ex_df1** and **indep_ex_df2** consist of simulated data of 4 trials of measurements for 100 and 80 subjects each, respectively. In this case, consider the situation where the 100 subjects tested in the first dataframe are completely different than the 80 subjects tested in the second dataframe. Since none of the subjects across the two dataframes are matching, the two are independent of one another. Like the dependent case, both dataframes are in wide format with rows representing the subjects and columns representing the trials.

In the independent example, **indep_ex_df1** may refer to the measurements of 100 subjects by a certain rater, Rater 1. Then, **indep_ex_df2** refers to the measurements of 80 different subjects by another rater, Rater 2. For this application, one would be interested in comparing the difference of the reliability of Rater 1 and Rater 2.

**Note**: Observe that the number of subjects is equal in both dataframes in the dependent case. This is required, since every subject of each dataframe must be found in the other dataframe. This is not the case in the independent dataframes: since the two independent dataframes have completely different sets of subjects, they are allowed to have a different number of subjects/rows.

# 3. Using the Functions with the Included Data

The dataframes included in this package provide correctly formatted, easily accessible data with which the package's functions can be run. The purpose of this is to demonstrate the functions' returns and interpretation. Both the dependent and independent case are used as examples.

## 3.1. Example with Dependent Data

This section provides an example of the usage of the **dep_ci()** function with the package's provided datasets.

The inputs of the **dep_ci()** function are:

* data1: the first dataframe (must be in wide format)
* data2: the second dataframe (must be in wide format)
* conf_level: confidence level of the confidence interval (defaults to 0.95 when not specified)

Say the user wanted to compute a 95% confidence interval for the difference between the ICC of **dep_ex_df1** and **dep_ex_df2**, storing the output in a variable called *result*. Remember in this example, dep_ex_df1 represents measurements of 100 subjects from a sensor at an initial time, and dep_ex_df2 represents the same sensor's measurements of the same 100 subjects at a final time. The user shall proceed with the following function:

```{r}
result <- dep_ci(dep_ex_df1, dep_ex_df2)
```

The function yields the following output:

* ICC of dep_ex_df1 = result\$data1ICC = `r result$data1ICC`
* ICC of dep_ex_df2 = result\$data2ICC = `r result$data2ICC`
* Confidence interval for the difference between dep_ex_df1 ICC and dep_ex_df2 ICC = result$confidenceIntervalDifference
    * Lower bound of confidence interval = result\$confidenceIntervalDifference\$lowerBound = `r result$confidenceIntervalDifference$lowerBound`
    * Upper bound of confidence interval = result\$confidenceIntervalDifference\$upperBound = `r result$confidenceIntervalDifference$upperBound`

In this case, we are 95% confident that the true difference between the ICC of dep_ex_df1 and the ICC of dep_ex_df2 lies in (`r result$confidenceIntervalDifference$lowerBound`, `r result$confidenceIntervalDifference$upperBound`). Since the interval is strictly positive and does not include zero, we have enough evidence to conclude that the true ICCs of the sensor at the initial time and the sensor at the final time are not equal. This means the ICC of the sensor has changed over time.

## 3.2. Example with Independent Data

This section provides an example of the usage of the **indep_ci()** function with the package's provided datasets.

The inputs of the **indep_ci()** function are:

* data1: the first dataframe (must be in wide format)
* data2: the second dataframe (must be in wide format)
* conf_level: confidence level of the confidence interval (defaults to 0.95 when not specified)

This time, the user wants to compute a 90% confidence interval for the difference between the ICC of **indep_ex_df1** and **indep_ex_df2**, storing the output in a variable called *result2*. Recall in this scenario, indep_ex_df1 contains the measurements of 100 subjects by Rater 1, and indep_ex_df2 contains the measurements of 80 different subjects of a different rater, Rater 2. The user shall proceed with the following function:

```{r}
result2 <- indep_ci(indep_ex_df1, indep_ex_df2, conf_level = 0.9)
```

The function yields the following output:

* ICC of indep_ex_df1 = result2\$data1ICC = `r result2$data1ICC`
* ICC of indep_ex_df2 = result2\$data2ICC = `r result2$data2ICC`
* Confidence interval for the difference between indep_ex_df1 ICC and indep_ex_df2 ICC = result2$confidenceIntervalDifference
    * Lower bound of confidence interval = result2\$confidenceIntervalDifference\$lowerBound = `r result2$confidenceIntervalDifference$lowerBound`
    * Upper bound of confidence interval = result2\$confidenceIntervalDifference\$upperBound = `r result2$confidenceIntervalDifference$upperBound`

In this case, we are 90% confident that the true difference between the ICC of indep_ex_df1 and the ICC of indep_ex_df2 lies in (`r result2$confidenceIntervalDifference$lowerBound`, `r result2$confidenceIntervalDifference$upperBound`). Since the interval includes zero, there is not enough evidence to conclude that the true ICC of Rater 1 and the true ICC of Rater 2 are unequal.

# 4. Frequent Errors

To demonstrate the possible errors encountered when using the functions in the compicc package, examples of dataframes that lead to certain errors are described below.

## 4.1. Unequal Number of Trials

To compute the ICC of a dataframe, every subject must go through the same number of trials during testing. In other words, each row in the dataframe must have the same number of columns of present data. Similarly, each dataframe being compared must have the same number of trials/columns. This means if dataframe 1 consists of 4 trials per subject, dataframe 2 must consist of exactly 4 trials per subject. An example of dataframes violating this condition is:

``` {r, error = T}
d1_trial1 <- c(34, 33, 36)
d1_trial2 <- c(41, 38, 40)
d1_trial3 <- c(37, 36, 37)
data1 <- data.frame(d1_trial1, d1_trial2, d1_trial3)

d2_trial1 <- c(33, 33, 35)
d2_trial2 <- c(43, 41, 42)
d2_trial3 <- c(36, 36, 38)
d2_trial4 <- c(29, 30, 29)
data2 <- data.frame(d2_trial1, d2_trial2, d2_trial3, d2_trial4)

indep_ci(data1, data2)
```

The dataframe data1 consists of 3 trials per subject, but data2 holds 4 trials per subject. The error message informs the user that the number of trials/columns must be equal across dataframes.

## 4.2. Unequal Number of Observations (Dependent case only)

In order for the two dataframes to be dependent, the subjects/rows must be matched across dataframes. This means row 1 of dataframe1 represents the same subject as row 1 of dataframe2, and so on for each additional row of data. Therefore, if there are an unequal number of subjects/rows between the two dataframes, the function **dep_ci()** will return an error message. The dataframes cannot be dependent when they have an unequal number of rows of data. Below is an example:

``` {r, error = T}
d1_trial1 <- c(34, 33, 36)
d1_trial2 <- c(41, 38, 40)
d1_trial3 <- c(37, 36, 37)
data1 <- data.frame(d1_trial1, d1_trial2, d1_trial3)

d2_trial1 <- c(33, 33, 35, 32)
d2_trial2 <- c(43, 41, 42, 43)
d2_trial3 <- c(36, 36, 38, 38)
data2 <- data.frame(d2_trial1, d2_trial2, d2_trial3)

dep_ci(data1, data2)
```

The error message tells the user that the number of rows must be equal across dataframes. When receiving this message, the user should adjust the dataframes to make sure that the subjects tested in each dataframe match each other and are placed in the same row in both dataframes.

Note: This is not an issue for the independent case. The **indep_ci()** function accepts dataframes with unequal numbers of observations, since the subjects should not match across dataframes.

## 4.3. Missing Values

The embedded functions in the compicc functions do not work with dataframes that consist of missing values. Therefore, if the user tries to call either the **dep_ci()** or **indep_ci()** function with a dataframe that has one or more NA or NaN value, the function will stop running and return an error message. An example of this is shown below:

``` {r, error = T}
d1_trial1 <- c(34, 33, 36)
d1_trial2 <- c(41, 38, 40)
d1_trial3 <- c(37, NA, 37)
data1 <- data.frame(d1_trial1, d1_trial2, d1_trial3)

d2_trial1 <- c(33, 33, 35)
d2_trial2 <- c(43, 41, 42)
d2_trial3 <- c(36, 36, 38)
data2 <- data.frame(d2_trial1, d2_trial2, d2_trial3)

dep_ci(data1, data2)
```

The error message states that there cannot be a missing value in either dataframe. The NA value in data1 (d1_subject3) must either be replaced with an imputed value, or subject 3's results must be discarded in order to use either function.

# 5. Description of Calculations

The functions in the compicc package include intensive calculations derived from Ramasundarahettige et al. (2009) to return the confidence interval of the difference of ICCs. The description of these calculations is provided for the users of the compicc package to understand and validate the functions' mathematical procedures.

The approach to estimating the difference between two ICCs begins with the simple case of one ICC. In this case, the formula of the confidence interval is derived from the central limit theorem and Slutsky's Theorem:

$L, H = \widehat{\rho} \pm (z_{\alpha/2})\sqrt{(\widehat{var}(\widehat{\rho})}$

Where L, H are the lower, upper bounds of the confidence interval, $\widehat{\rho}$ is the point estimate of the ICC, and $z_{\alpha/2}$ is the ${\alpha/2}$ quantile of the normal distribution.

Extending this to the difference of two ICCs, the formula becomes:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{var(\widehat{\rho}_1)+var(\widehat{\rho}_2)}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{var(\widehat{\rho}_1)+var(\widehat{\rho}_2)}$

Since the limits L and U may not be symmetrical around $\widehat{\rho_1}-\widehat{\rho_2}$, the variance terms must be expanded further. Considering the variance of one ICC estimate $\widehat{\rho_1}$ and the lower limit L, the variance is defined as:

$\widehat{var}(\widehat{\rho}_1) = (\hat{\rho}_1 - l_1)^2/(z_{\alpha/2})^2$

Where $l_1$ is the lower bound of the confidence interval of $\rho_1$, the first ICC.

Similarly, for the upper limit U:

$\widehat{var}_2(\widehat{\rho}_2) = (u_2 - \hat{\rho}_2)^2/(z_{\alpha/2})^2$

Where $l_2$ is the lower bound of the confidence interval of $\rho_2$, the second ICC.

Therefore, the square root term in the original equation $var(\widehat{\rho}_1)+var(\widehat{\rho}_2)$ expands as:

$var(\widehat{\rho}_1)+var(\widehat{\rho}_2) = (\hat{\rho}_1 - l_1)^2/(z_{\alpha/2})^2 + (u_2 - \hat{\rho}_2)^2/(z_{\alpha/2})^2$

Substituting this into the equations for the upper and lower bounds of the confidence interval:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2+(\widehat{\rho_2}-l_2)^2}$

These formulas will be referred to as Formulas 1.1 and 1.2.

Formulas 1.1 and 1.2 are used to calculate the confidence interval of the difference between two **independent** ICCs. If the squared terms were to be expanded (as done in the next step), a correlation term would arise. The correlation between two independent variables is identically zero, so the above formulas (1.1 and 1.2) are the final formulas used to calculate the confidence interval in the independent case.

For dependent data, the squared terms must be exapnded, since dependent data is correlated. The formulas 1.1 and 1.2 are expanded, with the following definition in mind:

$cov(\hat{\rho}_1, \hat{\rho}_2) = corr(\hat{\rho}_1, \hat{\rho}_2)*\sqrt{var(\widehat{\rho}_1)*var(\widehat{\rho}_2)}$

Which returns the equations:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(\widehat{\rho_1}-l_1)*(u_2-\widehat{\rho_2})+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(u_1-\widehat{\rho_1})*(\widehat{\rho_2}-l_2)+(\widehat{\rho_2}-l_2)^2}$

These formulas will be referred to as Formulas 2.1 and 2.2.

The term $\widehat{corr({\rho}_{1}{\rho}_{2})}$ is defined by Ramasundarahettige et al. (2009) as:

$\widehat{corr({\rho}_{1}{\rho}_{2})} = \widehat{\rho}_{12}^2*\frac{\sqrt{k_1*k_2*(k_1-1)*(k_2-1)}}{(1+(k_1-1)\widehat{\rho}_{1})(1+(k_2-1)\widehat{\rho}_{2})}$

Where $k_1$, $k_2$ are the number of measurements (trials) on each subject by systems 1 and 2, respectively; $\widehat{\rho}_{12}$ is the interclass correlation coefficient (Pearson's correlation "r") between systems 1 and 2.

$\widehat{\rho}_{12}$ is calculated as the Pearson product moment correlation between the first and second pair of all possible combinations of data points in both dataframes. This gives all of the values necessary to compute the limits of the confidence interval for the dependent case.

## 5.1. Independent Data

As a brief summary, the complete formulas used by the function indep_ci() for computing the bounds of the confidence interval for independent data are shown again:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2+(\widehat{\rho_2}-l_2)^2}$

## 5.2. Dependent Data

For dependent data, the complete formulas used by the function dep_ci() for the bounds of the confidence interval are:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(\widehat{\rho_1}-l_1)*(u_2-\widehat{\rho_2})+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(u_1-\widehat{\rho_1})*(\widehat{\rho_2}-l_2)+(\widehat{\rho_2}-l_2)^2}$

Where:

$\widehat{corr({\rho}_{1}{\rho}_{2})} = \widehat{\rho}_{12}^2*\frac{\sqrt{k_1*k_2*(k_1-1)*(k_2-1)}}{(1+(k_1-1)\widehat{\rho}_{1})(1+(k_2-1)\widehat{\rho}_{2})}$

For further reading into the calculations used in this package, reference the following reading:

Ramasundarahettige, C. F., Donner, A., & Zou, G. Y. (2009). Confidence Interval Construction for a Difference Between Two Dependent Intraclass Correlation Coefficients. *Statistics in Medicine*, 28(7), 1041–1053. https://doi.org/10.1002/sim.3523 

# 6. References

Matthias Gamer, Jim Lemon and Ian Fellows Puspendra Singh <puspendra.pusp22@gmail.com> (2019). irr: Various Coefficients of Interrater Reliability and Agreement. R package version 0.84.1. https://CRAN.R-project.org/package=irr

Ramasundarahettige, C. F., Donner, A., & Zou, G. Y. (2009). Confidence Interval Construction for a Difference Between Two Dependent Intraclass Correlation Coefficients. *Statistics in Medicine*, 28(7), 1041–1053. https://doi.org/10.1002/sim.3523 


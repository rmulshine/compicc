---
title: "compicc-explained"
authors: "Riley Mulshine" and "Alan Huebner"
date: "02/12/2022"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{compicc-explained}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# 1. Summary

The compicc package is intended for practicioners in a wide range of fields, most notably psychology, medicine, and sports science. It allows users to compare the reliability of two measurement systems or one system at two different time points. For example, one could compare the reliability of two different medical practicioners' measurements on patients' shoulder mobility in degrees of rotation. Similarly, a coach could study the reliability of a force plate measuring athletes' physical performances at two time points a year apart to determine if the system's reliability has drifted.

The two functions in compicc calculate the 95% confidence interval of the difference of one dataframe's intraclass correlation coefficient (ICC) versus another dataframe's ICC. These two functions are **dep_ci()** and **indep_ci()**, whose uses will be explained later.

In addition, the package contains two dataframes to be used as demonstrations of the functions' capabilities. These dataframes are titled ______ and ______. They consist of simulated data of __ trials of measurements __ subjects. Below, this document will call the package's functions with these dataframes and interpret the results for instruction purposes.

To start, the package is loaded with the code:

``` {r}
library(compicc)
```

# 2. Included Elements

The compicc package includes two different functions: **dep_ci()** and **indep_ci()**. Determining which function to use depends on whether the same set of subjects or a different set of subjects were tested in each dataset being compared.

## 2.1. Confidence Interval for Dependent Data: dep_ci()

Dependent data refers to the scenario in which the same set of subjects were tested in each dataset. For example, observations in row 1 of the first dataset are taken from the same subject as observations in row 1 of the second dataset. This holds true for every row of data, so the observations between datasets are "matched."

The **dep_ci()** function is called with two inputs: data1 and data2. The input data1 refers to the first dataset being compared, and data2 refers to the second dataset being compared.

The function will return 3 values:
* data1ICC: intraclass correlation coefficient of data1
* data2ICC: intraclass correlation coefficient of data2
* confidenceInterval: 1x2 dataframe with the lower bound and upper bound of the 95% confidence interval for the difference of the ICC of data1 and data2
** confidenceInterval$lowerBound: lower bound of confidence interval
** confidenceInterval$upperBound: upper bound of confidence interval

The confidence interval will represent the value *ICC(data1) - ICC(data2)*.

## 2.2. Confidence Interval for Inependent Data: indep_ci()

Independent data refers to the scenario in which an entirely different set of subjects were tested from one dataset to the next. This means there are no subjects who were tested in both the first dataframe and the second dataframe.

The **indep_ci()** function is called with two inputs: data1 and data2. The input data1 refers to the first dataset being compared, and data2 refers to the second dataset being compared.

The function will return 3 values:
* data1ICC: intraclass correlation coefficient of data1
* data2ICC: intraclass correlation coefficient of data2
* confidenceInterval: 1x2 dataframe with the lower bound and upper bound of the 95% confidence interval for the difference of the ICC of data1 and data2
** confidenceInterval$lowerBound: lower bound of confidence interval
** confidenceInterval$upperBound: upper bound of confidence interval

The confidence interval will represent the value *ICC(data1) - ICC(data2)*.

## 2.3. Included Data

# 3. Using the Functions with the Included Data

Two dataframes are included in the compicc package to provide correctly formatted, easily accessible data with which the package's functions can be run. The purpose of this is to demonstrate the functions' returns and interpretation.

# 4. Frequent Errors

To demonstrate the possible errors encountered when using the functions in the compicc package, examples of dataframes that lead to certain errors are described below.

## 4.1. Unequal Number of Trials

To compute the ICC of a dataframe, every subject must go through the same number of trials during testing. In other words, each row in the dataframe must have the same number of columns of present data. Similarly, each dataframe being compared must have the same number of trials/columns. This means if dataframe 1 consists of 4 trials per subject, dataframe 2 must consist of exactly 4 trials per subject. An example of dataframes violating this condition is:

``` {r}
d1_subject1 <- c(34, 33, 36)
d1_subject2 <- c(41, 38, 40)
d1_subject3 <- c(37, 36, 37)
data1 <- data.frame(d1_subject1, d1_subject2, d1_subject3)

d2_subject1 <- c(33, 33, 35, 32)
d2_subject2 <- c(43, 41, 42, 41)
d2_subject3 <- c(36, 36, 38, 37)
data2 <- data.frame(d2_subject1, d2_subject2, d2_subject3)

indep_ci(data1, data2)
```

The dataframe data1 consists of 3 trials per subject, but data2 holds 4 trials per subject. The error message informs the user that the number of trials/columns must be equal across dataframes.

## 4.2. Unequal Number of Observations (Dependent case only)

In order for the two dataframes to be dependent, the subjects/rows must be matched across dataframes. This means row 1 of dataframe1 represents the same subject as row 1 of dataframe2, and so on for each additional row of data. Therefore, if there are an unequal number of subjects/rows between the two dataframes, the function **dep_ci()** will return an error message. The dataframes cannot be dependent when they have an unequal number of rows of data. Below is an example:

``` {r}
d1_subject1 <- c(34, 33, 36)
d1_subject2 <- c(41, 38, 40)
d1_subject3 <- c(37, 36, 37)
data1 <- data.frame(d1_subject1, d1_subject2, d1_subject3)

d2_subject1 <- c(33, 33, 35)
d2_subject2 <- c(43, 41, 42)
d2_subject3 <- c(36, 36, 38)
d2_subject4 <- c(29, 28, 28)
data2 <- data.frame(d2_subject1, d2_subject2, d2_subject3, d2_subject4)

dep_ci(data1, data2)
```

The error message tells the user that the number of rows must be equal across dataframes. When receiving this message, the user should adjust the dataframes to make sure that the subjects tested in each dataframe match each other and are placed in the same row in both dataframes.

Note: This is not an issue for the independent case. The **indep_ci()** function accepts dataframes with unequal numbers of observations, since the subjects should not match across dataframes.

## 4.3. Missing Values

The embedded functions in the compicc functions do not work with dataframes that consist of missing values. Therefore, if the user tries to call either the **dep_ci()** or **indep_ci()** function with a dataframe that has one or more NA or NaN value, the function will stop running and return an error message. An example of this is shown below:

``` {r}
d1_subject1 <- c(34, 33, 36)
d1_subject2 <- c(41, 38, 40)
d1_subject3 <- c(37, NA, 37)
data1 <- data.frame(d1_subject1, d1_subject2, d1_subject3)

d2_subject1 <- c(33, 33, 35)
d2_subject2 <- c(43, 41, 42)
d2_subject3 <- c(36, 36, 38)
data2 <- data.frame(d2_subject1, d2_subject2, d2_subject3)

dep_ci(data1, data2)
```

The error message states that there cannot be a missing value in either dataframe. The NA value in data1 (d1_subject3) must either be replaced with an imputed value, or subject 3's results must be discarded in order to use either function.

# 5. Description of Calculations

The functions in the compicc package include intensive calculations derived from Ramasundarahettige et al. (2009) to return the confidence interval of the difference of ICCs. The description of these calculations is provided for the users of the compicc package to understand and validate the functions' mathematical procedures.

The approach to estimating the difference between two ICCs begins with the simple case of one ICC. In this case, the formula of the confidence interval is derived from the central limit theorem and Slutsky's Theorem:

$L, H = \widehat{\rho} \pm (z_{\alpha/2})\sqrt{(\widehat{var}(\widehat{\rho})}$

Where L, H are the lower, upper bounds of the confidence interval, $\widehat{\rho}$ is the point estimate of the ICC, and $z_{\alpha/2}$ is the ${\alpha/2}$ quantile of the normal distribution.

Extending this to the difference of two ICCs, the formula becomes:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{var(\widehat{\rho}_1)+var(\widehat{\rho}_2)}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{var(\widehat{\rho}_1)+var(\widehat{\rho}_2)}$

Since the limits L and U may not be symmetrical around $\widehat{\rho_1}-\widehat{\rho_2}$, the variance terms must be expanded further. Considering the variance of one ICC estimate $\widehat{\rho_1}$ and the lower limit L, the variance is defined as:

$\widehat{var}(\widehat{\rho}_1) = (\hat{\rho}_1 - l_1)^2/(z_{\alpha/2})^2$

Where $l_1$ is the lower bound of the confidence interval of $\rho_1$, the first ICC.

Similarly, for the upper limit U:

$\widehat{var}_2(\widehat{\rho}_2) = (u_2 - \hat{\rho}_2)^2/(z_{\alpha/2})^2$

Where $l_2$ is the lower bound of the confidence interval of $\rho_2$, the second ICC.

Therefore, the square root term in the original equation $var(\widehat{\rho}_1)+var(\widehat{\rho}_2)$ expands as:

$var(\widehat{\rho}_1)+var(\widehat{\rho}_2) = (\hat{\rho}_1 - l_1)^2/(z_{\alpha/2})^2 + (u_2 - \hat{\rho}_2)^2/(z_{\alpha/2})^2$

Substituting this into the equations for the upper and lower bounds of the confidence interval:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2+(\widehat{\rho_2}-l_2)^2}$

These formulas will be referred to as Formulas 1.1 and 1.2.

Formulas 1.1 and 1.2 are used to calculate the confidence interval of the difference between two **independent** ICCs. If the squared terms were to be expanded (as done in the next step), a correlation term would arise. The correlation between two independent variables is identically zero, so the above formulas (1.1 and 1.2) are the final formulas used to calculate the confidence interval in the independent case.

For dependent data, the squared terms must be exapnded, since dependent data is correlated. The formulas 1.1 and 1.2 are expanded, with the following definition in mind:

$cov(\hat{\rho}_1, \hat{\rho}_2) = corr(\hat{\rho}_1, \hat{\rho}_2)*\sqrt{var(\widehat{\rho}_1)*var(\widehat{\rho}_2)}$

Which returns the equations:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(\widehat{\rho_1}-l_1)*(u_2-\widehat{\rho_2})+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(u_1-\widehat{\rho_1})*(\widehat{\rho_2}-l_2)+(\widehat{\rho_2}-l_2)^2}$

These formulas will be referred to as Formulas 2.1 and 2.2.

The term $\widehat{corr({\rho}_{1}{\rho}_{2})}$ is defined by Ramasundarahettige et al. (2009) as:

$\widehat{corr({\rho}_{1}{\rho}_{2})} = \widehat{\rho}_{12}^2*\frac{\sqrt{k_1*k_2*(k_1-1)*(k_2-1)}}{(1+(k_1-1)\widehat{\rho}_{1})(1+(k_2-1)\widehat{\rho}_{2})}$

Where $k_1$, $k_2$ are the number of measurements (trials) on each subject by systems 1 and 2, respectively; $\widehat{\rho}_{12}$ is the interclass correlation coefficient (Pearson's correlation "r") between systems 1 and 2.

$\widehat{\rho}_{12}$ is calculated as the Pearson product moment correlation between the first and second pair of all possible combinations of data points in both dataframes. This gives all of the values necessary to compute the limits of the confidence interval for the dependent case.

## 5.1. Independent Data

As a brief summary, the complete formulas used by the function indep_ci() for computing the bounds of the confidence interval for independent data are shown again:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2+(\widehat{\rho_2}-l_2)^2}$

## 5.2. Dependent Data

For dependent data, the complete formulas used by the function dep_ci() for the bounds of the confidence interval are:

**Lower bound:** $L = \widehat{\rho_1}-\widehat{\rho_2}-\sqrt{(\widehat{\rho_1}-l_1)^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(\widehat{\rho_1}-l_1)*(u_2-\widehat{\rho_2})+(u_2-\widehat{\rho_2})^2}$

**Upper bound:** $U = \widehat{\rho_1}-\widehat{\rho_2}+\sqrt{(u_1-\widehat{\rho_1})^2-2*\widehat{corr({\rho}_{1}{\rho}_{2})}*(u_1-\widehat{\rho_1})*(\widehat{\rho_2}-l_2)+(\widehat{\rho_2}-l_2)^2}$

Where:

$\widehat{corr({\rho}_{1}{\rho}_{2})} = \widehat{\rho}_{12}^2*\frac{\sqrt{k_1*k_2*(k_1-1)*(k_2-1)}}{(1+(k_1-1)\widehat{\rho}_{1})(1+(k_2-1)\widehat{\rho}_{2})}$

For further reading into the calculations used in this package, reference the following reading:

Ramasundarahettige, C. F., Donner, A., & Zou, G. Y. (2009). Confidence Interval Construction for a Difference Between Two Dependent Intraclass Correlation Coefficients. *Statistics in Medicine*, 28(7), 1041–1053. https://doi.org/10.1002/sim.3523 

# 6. References

Matthias Gamer, Jim Lemon and Ian Fellows Puspendra Singh <puspendra.pusp22@gmail.com> (2019). irr: Various Coefficients of Interrater Reliability and Agreement. R package version 0.84.1. https://CRAN.R-project.org/package=irr

Ramasundarahettige, C. F., Donner, A., & Zou, G. Y. (2009). Confidence Interval Construction for a Difference Between Two Dependent Intraclass Correlation Coefficients. *Statistics in Medicine*, 28(7), 1041–1053. https://doi.org/10.1002/sim.3523 

